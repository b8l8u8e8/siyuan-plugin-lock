name: 赞助者信息更新 (Sponsor Sync)

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: sponsor-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lock repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect default branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT_BRANCH="$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')"
          echo "default_branch=$DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"
          echo "Default branch: $DEFAULT_BRANCH"

      - name: Fetch sponsor-list.md from share repo
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "https://raw.githubusercontent.com/b8l8u8e8/siyuan-plugin-share/HEAD/sponsor-list.md" -o sponsor-list.md

      - name: Check if changed
        id: changed
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f sponsor-list.md ]; then
            echo "sponsor-list.md not found in lock repo (will add it)."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git diff --no-index --quiet sponsor-list.md sponsor-list.md 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if diff -q sponsor-list.md sponsor-list.md >/dev/null 2>&1; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compare with repo file
        id: diffcheck
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f sponsor-list.md ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mv sponsor-list.md /tmp/sponsor-list.from-share.md

          if [ ! -f sponsor-list.md ]; then
            echo "No local sponsor-list.md, will create."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            cp /tmp/sponsor-list.from-share.md sponsor-list.md
            exit 0
          fi

          if diff -q sponsor-list.md /tmp/sponsor-list.from-share.md >/dev/null; then
            echo "No changes."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            cp /tmp/sponsor-list.from-share.md sponsor-list.md
          fi

      - name: Commit & push (if changed)
        if: steps.diffcheck.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add sponsor-list.md
          git commit -m "chore: sync sponsor-list.md from share"
          git push origin "HEAD:${{ steps.branch.outputs.default_branch }}"
