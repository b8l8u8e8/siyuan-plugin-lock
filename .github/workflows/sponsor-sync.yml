name: 赞助者信息更新 (Sponsor Sync)

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: sponsor-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout lock repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect default branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT_BRANCH="$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')"
          echo "default_branch=$DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"
          echo "Default branch: $DEFAULT_BRANCH"

      - name: Fetch sponsor-list.md from share repo (to temp)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "https://raw.githubusercontent.com/b8l8u8e8/siyuan-plugin-share/HEAD/sponsor-list.md" \
            -o /tmp/sponsor-list.from-share.md

      - name: Compare & update working tree
        id: diffcheck
        shell: bash
        run: |
          set -euo pipefail

          # 如果仓库里还没有 sponsor-list.md，直接创建
          if [ ! -f sponsor-list.md ]; then
            echo "No local sponsor-list.md, will create."
            cp /tmp/sponsor-list.from-share.md sponsor-list.md
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 有文件则对比：相同就不动；不同就覆盖
          if diff -q sponsor-list.md /tmp/sponsor-list.from-share.md >/dev/null; then
            echo "No changes."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed."
            cp /tmp/sponsor-list.from-share.md sponsor-list.md
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit & push (if changed)
        if: steps.diffcheck.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add sponsor-list.md

          # ✅ 保险：即使误判 changed，也不会因为“无可提交”而失败
          if git diff --cached --quiet; then
            echo "No changes staged, skip commit."
            exit 0
          fi

          git commit -m "chore: sync sponsor-list.md from share"
          git push origin "HEAD:${{ steps.branch.outputs.default_branch }}"
